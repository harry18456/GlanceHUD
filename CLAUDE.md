# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Project Overview

GlanceHUD 是一個跨平台桌面懸浮監控儀表板，使用 **Wails v3 Alpha** (Go + React) 構建。目前主要開發/測試環境為 Windows。核心設計哲學是 **Backend-Driven UI**：後端決定「畫什麼」和「何時更新」，前端只負責渲染標準協議組件。

## Commands

```bash
# Development (hot reload)
task dev                         # 或 wails3 dev

# Build
task build                       # 依 OS 自動選擇平台建置
go build                         # 直接編譯 → GlanceHUD.exe

# Frontend only
cd frontend && npm install       # 安裝依賴
cd frontend && npm run dev       # Vite dev server (port 9245)
cd frontend && npm run build     # 生產建置

# Server mode (no GUI, HTTP server only)
task build:server
task run:server

# Version bump
task bump VERSION=0.x.x          # 更新 wails.json + build/config.yml + frontend/package.json
```

**No tests exist yet** — Go 和 frontend 皆無測試。

## Architecture

### Data Flow (Push-Based Events)

```
Go Module.Update()
  → goroutine ticker (per module, independent intervals)
  → diff check (reflect.DeepEqual against cache)
  → app.Event.Emit("stats:update", UpdateEvent{ID, Data})
  → Wails WebSocket bridge
  → Frontend Events.On("stats:update") → setDataMap(prev => {...prev, [id]: data})
```

### Two Wails Services

| Service         | File                                 | Purpose                                                                                                                                                                                                                 |
| --------------- | ------------------------------------ | ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| `SystemService` | `internal/service/system_service.go` | Module lifecycle, goroutine scheduling, event emit, config management. Exposes RPC: `GetModules`, `GetCurrentData`, `GetConfig`, `SaveConfig`, `GetModuleConfigSchema`, `SetWindowMode`, `SetEditMode`, `UpdateOpacity` |
| `APIService`    | `internal/service/api_service.go`    | HTTP server on `:9090`. `POST /api/widget` for sidecar data push. `GET /api/stats` returns all widget snapshots (id, type, title, data, isOffline).                                                                     |

### Module Interface

Each monitor module implements `Module` (`internal/modules/module.go`):

```go
type Module interface {
    ID() string
    GetRenderConfig() protocol.RenderConfig   // Static UI template (type, title, props)
    GetConfigSchema() []protocol.ConfigSchema  // Settings form schema
    Update() (*protocol.DataPayload, error)    // Dynamic data
    ApplyConfig(props map[string]interface{})  // Apply user settings + minimalMode
    Interval() time.Duration                   // Update frequency
}
```

| Module  | File                       | Interval | Normal Type | Minimal Type |
| ------- | -------------------------- | -------- | ----------- | ------------ |
| CPU     | `internal/modules/cpu.go`  | 1s       | `sparkline` | `key-value`  |
| Memory  | `internal/modules/mem.go`  | 2s       | `gauge`     | `key-value`  |
| Disk    | `internal/modules/disk.go` | 10s      | `bar-list`  | `key-value`  |
| Network | `internal/modules/net.go`  | 1s       | `key-value` | `key-value`  |

### Display Protocol (`internal/protocol/protocol.go`)

Supported component types: `gauge`, `bar-list`, `key-value`, `sparkline`. `group` is planned. Each module returns a static `RenderConfig` (template) and dynamic `DataPayload` (data). `DataPayload.Props` can dynamically override static config props (e.g., color change on threshold).

Module IDs follow namespace format: `glancehud.core.cpu`, `glancehud.core.mem`, etc.

### Config System

`config.json` (root dir, gitignored) → `ConfigService` (`internal/modules/config.go`, `sync.RWMutex`) → frontend `SettingsModal` auto-generates forms from `GetConfigSchema()` → `SaveConfig()` writes + auto-restarts all monitoring goroutines.

`MinimalMode` is a global flag injected into every module's `ApplyConfig()` as `mergedProps["minimal_mode"]`, causing `GetRenderConfig()` to switch component type.

### Frontend Stack

- React 19 + TypeScript + Vite + **TailwindCSS v4** (`@import "tailwindcss"` syntax) + Framer Motion + `react-grid-layout`
- `frontend/bindings/` — Wails auto-generated Go↔JS bindings. **Never modify manually.** Regenerated by `wails3 generate bindings`.
- Window: frameless, transparent, always-on-top, `DisableResize=true`. Width and height are both dynamic, driven by `useAutoResize(gridWidth)` (`ResizeObserver` → `Window.SetSize`). Default width ≈400px (5 cols × 80px).
- Glass-morphism design with status colors: healthy (#22c55e <60%), warning (#f59e0b 60-85%), critical (#ef4444 >85%). See `frontend/src/lib/statusColor.ts`.
- Drag via CSS: `.drag-region { --wails-draggable: drag }`, interactive elements use `.no-drag`.
- Design tokens defined in `frontend/src/style.css` (glass-bg, glass-border, text-primary/secondary/tertiary, font-mono: JetBrains Mono, font-sans: Inter).

### Frontend Component Architecture

```
App.tsx (state: modules[], dataMap{}, isSettingsOpen, isEditMode, isLocked, appConfig)
├── useAutoResize(gridWidth) — ResizeObserver → Window.SetSize(w, h)
├── SettingsModal — inline panel (not modal overlay), schema-driven DynamicForm
├── HudGrid — react-grid-layout wrapper; edit mode enables drag/resize
│   └── UniversalWidget — protocol-driven renderer, switches by config.type:
│       ├── GaugeRenderer → RingProgress + AnimatedNumber
│       ├── BarListRenderer → motion.div progress bars
│       ├── KVRenderer → AnimatePresence + IconFromName (lucide-react)
│       ├── SparklineRenderer → SVG rolling history chart (history buffer in frontend)
│       └── TextRenderer → AnimatedNumber
└── DebugConsole — toggled by appConfig.debugConsole
```

### Grid System (HudGrid)

`HudGrid` uses `react-grid-layout` with fine-grained units: **CELL_WIDTH=80px, ROW_HEIGHT=40px, GAP=8px**.

Default widget sizes (also minimum sizes):
| Type | w | h | px |
|------|---|---|----|
| gauge | 2 | 3 | ~160×120 |
| bar-list | 3 | 3 | ~240×120 |
| key-value | 2 | 3 | ~160×120 |
| text | 2 | 2 | ~160×80 |

**Model vs Render coordinates**: Layout positions stored in `config.json` (Model space) may start at any `(x,y)`. The "Virtual Origin" (`layoutOffset`) is the minimum `(x,y)` across enabled widgets; HudGrid shifts all positions by `-offset` before passing to RGL so the grid always starts at `(0,0)`. `App.tsx` converts RGL layout back to Model space on save by adding `offset` back.

### Window Modes & Events

Three modes, toggled via tray or header:

- **normal** — default, draggable
- **locked** — `IgnoreMouseEvents=true` (click-through), cannot open settings
- **edit** — drag/resize widgets via react-grid-layout; save on toggle-off

Frontend Wails events (`Events.On`):
| Event | Direction | Payload |
|-------|-----------|---------|
| `stats:update` | Go→JS | `UpdateEvent{id, data}` |
| `widget:update` | Go→JS | same (legacy sidecar alias) |
| `config:update` | Go→JS | `{opacity}` |
| `mode:change` | Go→JS | `{windowMode?}` or `{editMode?}` |
| `open:settings` | Go→JS | none |
| `config:reload` | Go→JS | none — reload modules + config |

### Wails Event Gotcha

`event.data` from Wails may be array-wrapped or direct object. Always handle both:

```typescript
const payload = Array.isArray(event.data) ? event.data[0] : event.data;
```

### StartMonitoring Two-Phase Design

`SystemService.StartMonitoring()` uses two phases to avoid deadlock:

- **Phase 1** (under `mu.Lock`): stop old goroutines, rebuild cache, collect tasks
- **Phase 2** (after `mu.Unlock`): launch new goroutines

### Sidecar TTL

`SystemService` runs a background TTL checker (1s tick). If a sidecar's `LastSeen` exceeds **10 seconds**, it is marked `IsOffline=true` and a `stats:update` is emitted with `props.isOffline=true` added to the last known payload.

### Key Directories

- `internal/modules/` — Go monitor modules + ConfigService
- `internal/protocol/` — All shared type definitions (Display + Config + Sidecar protocols)
- `internal/service/` — HTTP API service + `WidgetSource` interface (`widget_source.go`) unifying native modules and `SidecarSource`
- `frontend/src/components/` — React components (UniversalWidget, renderers, SettingsModal)
- `frontend/src/lib/` — Hooks and utilities (useAutoResize, statusColor)
- `frontend/bindings/` — Auto-generated Wails bindings (do not edit)
- `frontend/src/widgets/` — **Legacy** widget files (CpuWidget, DiskWidget, etc.) — unused, superseded by UniversalWidget
- `examples/` — Sidecar example scripts (`python-sidecar.py` covers all 5 widget types; `gpu-monitor.py` is a real NVIDIA GPU monitoring sidecar using `pynvml`)

## Important Notes

- Go module name: `glancehud` (not a github path). Imports: `glancehud/internal/...`
- `//go:embed all:frontend/dist` in `main.go` embeds frontend build output
- Wails v3 is Alpha — API may change between versions
- System data collection: `github.com/shirou/gopsutil/v4`
- Windows production build flags: `-tags production -trimpath -ldflags="-w -s -H windowsgui"`
- `config.json` is gitignored (user-local settings); defaults auto-generated by `ConfigService.buildDefaultWidgets()`
- Version string appears in: `wails.json`, `build/config.yml`, `frontend/package.json`, **and `version.go`** (Go `Version` const used by system tray). `App.tsx` reads version from `package.json` via Vite import.
- **Windows hit-test workaround**: `main.go` creates the HUD window at 3840×2160 with `Hidden=true`. `WS_EX_LAYERED` windows on Windows have a fixed hit-test region set at creation time. Creating large + hiding prevents the click-through bug when frontend resizes the window. `useAutoResize` calls `Window.Show()` after the first successful `SetSize`.
- **useAutoResize DPR note**: `Window.SetSize` takes logical (CSS) pixels for width but `scrollHeight` must be multiplied by `devicePixelRatio` for height — WebView2 reports layout in physical pixels.

## Release & Versioning

- **Version Bump**: Before finalizing (or archiving) any feature change, ALWAYS ask the user if the version number needs to be bumped. If the user agrees, run `node scripts/bump_version.js <new_version>` or similar command to bump the version in `version.go`, `wails.json`, `frontend/package.json`, and `build/config.yml`.
